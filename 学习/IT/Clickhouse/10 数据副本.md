# 10 数据副本

## 集群机制

作用：

1. 数据副本
2. 分布式表

## 集群副本

数据冗余备份，高可用，数据副本

可多机组成集群，各节点平等关系，不分主从，集群的协调者使用zookeeper

集群副本只针对与MergeTree表引擎：Replicated*MergeTree，设置对象是表

同步过程：

1. 客户端往节点a写数据
2. 节点a响应客户端
3. 之后节点a通过异步的方式将数据同步到其他节点

注意事项：

1. 数据的同步是有延迟的
2. 对于insert语句，只会等待一个副本成功写入即返回；多个副本时，不保证所有副本的成功同步
3. 写入数据，单个数据块具有原子性，但不保证多个数据块写入的原子性
4. 数据块写入时会去重，避免多次执行相同语句
5. 基本不需要担心zookeeper的性能问题（例：一个Zookeeper处理Yandex.Metrica集群的300台服务器，可以支撑协调每秒几百个INSERT的场景）
6. 生产环境必配副本

实操：

1. 搭建zookeeper
2. clickhouse配置zookeeper连接（配置目录：config.xml）
3. 创建复制表（两个传参：zookeep路径（所有节点一致），节点名称（唯一）），可以使用宏（macros）（例：${replica}），配置在配置文件，相当于一个env这样的环境变量配置。
4. 建表需要同时在所有副本中执行

## 分布式表

表数据分布到多节点上，解决单机的问题

由于clickhouse大量数据（30亿数据200G硬盘）以及大量查询（30亿数据秒级别）下表现优秀，而且分布式表需要网络资源，表现可能更差，所以大部分场景下都不需要。