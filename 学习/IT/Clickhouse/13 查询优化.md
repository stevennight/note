# 13 查询优化

## 查询执行计划

```sql
EXPLAIN [AST|SYNTAX|PLAN|PIPELINE] [setting = value] ... [FORMAT ...]
```

AST：查看抽象语法树

SYNTAX：常用 查看AST优化后SQL

PLAN：常用 查看执行计划

PIPELINE：查看管道计划（pipeline）

## 内置语法优化规则

1. count 优化
    1. count(*) 没有where条件，直接返回table的行数 （count.txt文件）
2. 聚合计算外推
    1. select sum(userId*2) from xxx → select sum(userId)* 2 from xxx
3. 谓词下推
    1. 先过滤再聚合
    2. 优化条件：group by有having子句，没有with cube, with rollup, with totals时，having条件会提前到where过滤。
    3. 需打开谓词下推设置：enable_optimize_predicate_expression
4. 三元运算优化
    1. 多个三元运算嵌套会被转成multiIf函数
    2. 需打开设置：optimize_if_chain_to_multiif，关闭时三元运算会转成if函数
5. 聚合函数的取消
    1. 取消没有意义的聚合函数min,max,any等

## 高性能查询优化

1. 选择合适的表引擎
2. 建表不要用Nullable
3. 合适的划分分区和索引
    1. 建议单分区数据不要超过100万
    2. 时间建议按天分区
4. 数据变更优化
    1. 变更不宜太频繁，会产生大量临时分区
    2. 建议1秒发起一次写入操作，每次写入数据2w-5w之间
5. 使用prewhere代替where
    1. where会读取整行数据进行过滤；prewhere会先根据列数据进行过滤，后续在补全其他列；减少IO
    2. 默认会将where优化为prewhere
    3. 优化配置参数：optimize_move_to_prewhere
