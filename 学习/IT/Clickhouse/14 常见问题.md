# 14 常见问题

## 数据一致性问题

clickhouse 只能保证最终一致性，而无法保证强一致性。

原因：

1. 场景：OLAP 事务控制弱。类比kafka吞吐量高，但是极限性能下丢消息
2. 底层：merge 合并机制

处理方式：

1. 分布式表：
    1. 尽量避免使用分布式表（不同节点的数据一致性问题，好比MySQL主从/读写分离也有数据一致性问题）
    2. 若要使用：
        1. 使用副本表 用以数据恢复（?但是如果使用一个节点写入再异步写入其他节点，这个可有用？）
        2. 每次写入数据少，减少数据问题的范围
2. 本地数据库
    1. 多副本造成的数据一致性问题
    2. ReplacingMergeTree
        1. 定期手动执行optimize进行数据的合并，由于clickhouse执行optimize是未知的。但是注意业务低峰期执行，会影响到查询功能
        2. 业务上进行保证：代码上实现乐观锁：_version版本号，_sign是否删除。查最新版本号，以及sign。需要定期清理无用旧数据。

## 多副本表，尽量固定写入节点

人为划分主从，避免写入多个节点导致的数据混乱。

恢复数据，将要恢复的文件复制到目标服务器上即可。

## ZooKeeper数据丢失导致副本表无法启动

重建zookeeper中的信息：

1. 移除问题节点上的metadata中对应表结构的文件
2. 启动clickhousr并重建表：从正常的节点中复制建表语句建表
3. 服务会从其他节点中下载数据

## More

阿里云clickhouse 常见问题排查

## 总结

1. 能支持完整的数仓功能
2. 性能强，一般单机也足够
3. 水平扩展简单，高效
4. 设计简单，迭代快，低技术门槛
